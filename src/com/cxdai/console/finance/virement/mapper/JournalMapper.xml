<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.cxdai.console.finance.virement.mapper.JournalMapper" >
  <resultMap id="BaseResultMap" type="com.cxdai.console.finance.virement.entity.Journal" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <id column="ID" property="id" jdbcType="INTEGER" />
    <result column="OPERATION_DATE" property="operationDate" jdbcType="TIMESTAMP" />
    <result column="DEBIT_AMOUNT" property="debitAmount" jdbcType="DECIMAL" />
    <result column="CREDIT_AMOUNT" property="creditAmount" jdbcType="DECIMAL" />
    <result column="STATUS" property="status" jdbcType="TINYINT" />
    <result column="TYPE" property="type" jdbcType="TINYINT" />
    <result column="THIRD_PLATFORM" property="thirdPlatform" jdbcType="TINYINT" />
    <result column="BALANCE" property="balance" jdbcType="DECIMAL" />
    <result column="REMARK" property="remark" jdbcType="VARCHAR" />
    <result column="ADDTIME" property="addtime" jdbcType="TIMESTAMP" />
    <result column="ADDUSER" property="adduser" jdbcType="INTEGER" />
    <result column="ADDIP" property="addip" jdbcType="VARCHAR" />
    <result column="UPDATETIME" property="updatetime" jdbcType="TIMESTAMP" />
    <result column="UPDATEUSER" property="updateuser" jdbcType="INTEGER" />
    <result column="UPDATEIP" property="updateip" jdbcType="VARCHAR" />
  </resultMap>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Integer" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    delete from cw_journal
    where ID = #{id,jdbcType=INTEGER}
  </delete>
  <insert id="insert" parameterType="com.cxdai.console.finance.virement.entity.Journal" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    insert into cw_journal (OPERATION_DATE, DEBIT_AMOUNT, 
      CREDIT_AMOUNT, STATUS, BALANCE, 
      REMARK, ADDTIME, ADDUSER, 
      ADDIP, UPDATETIME, UPDATEUSER, 
      UPDATEIP, TYPE<if test="type == 2">, THIRD_PLATFORM</if>)
    values (#{operationDate,jdbcType=TIMESTAMP}, #{debitAmount,jdbcType=DECIMAL}, 
      #{creditAmount,jdbcType=DECIMAL}, #{status,jdbcType=TINYINT}, #{balance,jdbcType=DECIMAL}, 
      #{remark,jdbcType=VARCHAR}, now(), #{adduser,jdbcType=INTEGER}, 
      #{addip,jdbcType=VARCHAR}, now(), #{updateuser,jdbcType=INTEGER}, 
      #{updateip,jdbcType=VARCHAR}, #{type,jdbcType=TINYINT}<if test="type == 2">, #{thirdPlatform,jdbcType=TINYINT}</if>)
  </insert>
  <update id="updateByPrimaryKey" parameterType="com.cxdai.console.finance.virement.entity.Journal" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update cw_journal
    set OPERATION_DATE = #{operationDate,jdbcType=TIMESTAMP},
      DEBIT_AMOUNT = #{debitAmount,jdbcType=DECIMAL},
      CREDIT_AMOUNT = #{creditAmount,jdbcType=DECIMAL},
      BALANCE = #{balance,jdbcType=DECIMAL},
      REMARK = #{remark,jdbcType=VARCHAR},
      TYPE = #{type,jdbcType=TINYINT},
      <if test="type == 2">THIRD_PLATFORM = #{thirdPlatform,jdbcType=TINYINT},</if>
      UPDATETIME = now(),
      UPDATEUSER = #{updateuser,jdbcType=INTEGER},
      UPDATEIP = #{updateip,jdbcType=VARCHAR}
    where ID = #{id,jdbcType=INTEGER}
  </update>
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Integer" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select ID, OPERATION_DATE, DEBIT_AMOUNT, CREDIT_AMOUNT, STATUS, BALANCE, REMARK, 
    ADDTIME, ADDUSER, ADDIP, UPDATETIME, UPDATEUSER, UPDATEIP, TYPE, THIRD_PLATFORM
    from cw_journal
    where ID = #{id,jdbcType=INTEGER}
  </select>
  <select id="selectAll" resultMap="BaseResultMap" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select ID, OPERATION_DATE, DEBIT_AMOUNT, CREDIT_AMOUNT, STATUS, BALANCE, REMARK, 
    ADDTIME, ADDUSER, ADDIP, UPDATETIME, UPDATEUSER, UPDATEIP, TYPE, THIRD_PLATFORM
    from cw_journal
  </select>
  
  <sql id="where_journal_sql">
  	<where>
  		<if test="status != null and status != ''">
  			AND cj.`STATUS` = #{status}
  		</if>
  		<choose>
  			<when test="searchType == 1 and operationDate != null and operationDate != ''">
  				AND DATE_FORMAT(cj.OPERATION_DATE, '%Y-%m-%d') = #{operationDate}
  			</when>
  			<when test="searchType == 2 and operationDate != null and operationDate != ''">
  				AND DATE_FORMAT(cj.OPERATION_DATE, '%Y-%m') = #{operationDate}
  			</when>
  			<when test="searchType == 3 and operationDate != null and operationDate != ''">
  				AND DATE_FORMAT(cj.OPERATION_DATE, '%Y') = #{operationDate}
  			</when>
  			<otherwise></otherwise>
  		</choose>
  		<if test="adduser != null and adduser != ''">
  			AND cj.ADDUSER = #{adduser}
  		</if>
  		<if test="type != null and type != ''">
  			AND cj.TYPE = #{type}
  		</if>
  		<if test="thirdPlatform != null and thirdPlatform != ''">
  			AND cj.THIRD_PLATFORM = #{thirdPlatform}
  		</if>
  	</where>
  </sql>
  <select id="queryListCountByCnd" parameterType="com.cxdai.console.finance.virement.vo.JournalCnd" resultType="int">
  	SELECT COUNT(*) FROM cw_journal cj <include refid="where_journal_sql" />
  </select>
  
  <resultMap type="com.cxdai.console.finance.virement.vo.JournalVo" id="journal_resultMap" extends="BaseResultMap">
  	<result column="FLAG" property="flag" jdbcType="INTEGER" />
  	<result column="ACCOUNT_DATE" property="accountDate" jdbcType="DATE" />
  </resultMap>
  <select id="queryListByCnd" parameterType="com.cxdai.console.finance.virement.vo.JournalCnd" resultMap="journal_resultMap">
  	SELECT cj.*, 
  		CASE 
  		WHEN (<![CDATA[DATE_FORMAT(cj.OPERATION_DATE, '%Y-%m-%d') >= (SELECT MAX(DATE_FORMAT(cj1.OPERATION_DATE, '%Y-%m-%d')) FROM `cw_journal` cj1 WHERE cj1. STATUS = 1 AND cj1.TYPE = #{type})]]>) THEN 1
		WHEN (<![CDATA[DATE_FORMAT(cj.OPERATION_DATE, '%Y-%m-%d') < (SELECT MAX(DATE_FORMAT(cj2.OPERATION_DATE, '%Y-%m-%d')) FROM `cw_journal` cj2 WHERE cj2. STATUS = 1 AND cj2.TYPE = #{type})]]>) THEN 2
		END AS FLAG FROM `cw_journal` cj <include refid="where_journal_sql" /> ORDER BY cj.OPERATION_DATE DESC
  </select>
  
  <!-- 查询最新的现金日记账 -->
  <select id="selectMaxJournal" parameterType="com.cxdai.console.finance.virement.vo.JournalVo" resultMap="journal_resultMap">
  	SELECT cj.*, DATE_FORMAT(cj.OPERATION_DATE, '%Y-%m-%d') AS ACCOUNT_DATE FROM `cw_journal` cj WHERE cj.STATUS = 1 AND cj.TYPE = #{type} ORDER BY cj.OPERATION_DATE DESC LIMIT 1
  </select>
  
  <select id="selectPreOneJournal" parameterType="com.cxdai.console.finance.virement.vo.JournalVo" resultMap="journal_resultMap">
  	SELECT cj.*, DATE_FORMAT(cj.OPERATION_DATE, '%Y-%m-%d') AS ACCOUNT_DATE FROM `cw_journal` cj WHERE cj.STATUS = 1 AND cj.TYPE = #{type} AND cj.ID <![CDATA[<=]]> #{id} - 1 ORDER BY cj.OPERATION_DATE DESC LIMIT 1
  </select>
  
  <select id="selectJournalForUpdate" resultMap="BaseResultMap" parameterType="java.lang.Integer" >
    select ID, OPERATION_DATE, DEBIT_AMOUNT, CREDIT_AMOUNT, STATUS, BALANCE, REMARK, 
    ADDTIME, ADDUSER, ADDIP, UPDATETIME, UPDATEUSER, UPDATEIP, TYPE
    from cw_journal
    where ID = #{id,jdbcType=INTEGER} FOR UPDATE
  </select>
  
  <delete id="deleteJournal" parameterType="com.cxdai.console.finance.virement.entity.Journal">
  	update cw_journal
    set STATUS = #{status,jdbcType=TINYINT},
      UPDATETIME = now(),
      UPDATEUSER = #{updateuser,jdbcType=INTEGER},
      UPDATEIP = #{updateip,jdbcType=VARCHAR}
    where ID = #{id,jdbcType=INTEGER}
  </delete>
  
  <select id="findJournalList" resultType="map" parameterType="com.cxdai.console.finance.virement.vo.JournalCnd">
  	SELECT 
		DATE_FORMAT(cj.OPERATION_DATE, '%Y-%m-%d') AS operationDate,
		cj.DEBIT_AMOUNT AS debitAmount,
		cj.CREDIT_AMOUNT AS creditAmount,
		cj.BALANCE AS balance,
		cj.REMARK AS remark,
		CASE WHEN cj.DEBIT_AMOUNT IS NOT NULL THEN '借' WHEN cj.CREDIT_AMOUNT IS NOT NULL THEN '贷' END AS debitOrCredit 
	FROM cw_journal cj  <include refid="where_journal_sql" />ORDER BY cj.OPERATION_DATE DESC
  </select>
  
  <select id="selectAfterCurrentOperationDateThisDay" parameterType="com.cxdai.console.finance.virement.vo.JournalVo" resultMap="BaseResultMap">
  	SELECT cj.* FROM cw_journal cj WHERE cj.`STATUS` = 1 AND cj.OPERATION_DATE >= #{operationDate} AND cj.TYPE = #{type} AND cj.ID >= #{id} + 1
  </select>
  
</mapper>